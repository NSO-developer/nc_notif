# nc_notif
 
# Description

Thie is an NSO example showing how to work with NETCONF notifications to stay in sync with the device

To keep NSO synchronized with out-of-band config changes on the device, a kicker service has been written
to monitor the NETCONF notifications from the device and take action to sync with the device as necessary.

## How was this project created?

Use NSO 6.0

Grab the 10/20/2022 version of OpenConfig YANG models from the public github at https://github.com/openconfig

Flatten the YANG files into a single directory and place them under a directory named yang

Add iana-if-type.yang, ietf-inet-types.yang, ietf-netconf-monitoring.yang, ietf-netconf.yang, ietf-netconf-notifications.yang, ietf-yang-types.yang to the yang directory.  This will allow NETCONF notifications to be generated by netsim devices.

Fix any YANG syntax issues in openconfig-access-points.yang, openconfig-inet-types.yang, openconfig-network-instance.yang, openconfig-terminal-device.yang

```
$ cd nc_notif
$ ls
yang
$ ncs-make-package --netconf-ned ./yang oc-all
nc_notif $ cd oc-all/src
$ make (remove all fail-on-warnings in Makefile)
$ cd ../..
$ ncs-netsim create-network oc-all 2 dev
$ ncs-setup --dest .
Modify netsim/dev/dev0/confd.conf and netsim/dev/dev1/confd.conf by adding the notification XML block inside /netconf/capabilities to enable NETCONF notifications

The notification XML block looks as follows:

<notification>
  <enabled>true</enabled>
</notification>

Add the nc-config-change Python package to the packages directory.  The skeleton service package for Python can be created using “ncs-make-package --service-skeleton python ‘service-package-name’”
```

## To start both the netsim devices and NSO

```
nc_notif $ source path-of-NCS_DIR/ncsrc
nc_notif $ ncs-netsim start
nc_notif $ ncs
```

## Demo

The demo steps will walk you through how to set up NSO to receive the NETCONF notifications and how to set up the Kicker service to monitor the received NETCONF notifications.

Config changes are then made to the device both out-of-band and through NSO to show actions taken by the Kicker service application.

## Setting up NSO to receive the config changes notifications from the device

```
nc_notif $ ncs_cli -Cu admin
admin@ncs# show devices device dev0 notifications stream
                                                REPLAY    REPLAY  
                                                LOG       LOG     
                                       REPLAY   CREATION  AGED    
NAME     DESCRIPTION                   SUPPORT  TIME      TIME    
------------------------------------------------------------------
NETCONF  default NETCONF event stream  false    -         -       
       
admin@ncs# show devices device dev0 notifications notification-name 
NAME                       URI                                                     
-----------------------------------------------------------------------------------
netconf-confirmed-commit   urn:ietf:params:xml:ns:yang:ietf-netconf-notifications  
netconf-session-end        urn:ietf:params:xml:ns:yang:ietf-netconf-notifications  
netconf-session-start      urn:ietf:params:xml:ns:yang:ietf-netconf-notifications  
netconf-capability-change  urn:ietf:params:xml:ns:yang:ietf-netconf-notifications  
netconf-config-change      urn:ietf:params:xml:ns:yang:ietf-netconf-notifications 

admin@ncs(config-device-dev0)# notifications 
Possible completions:
  received-notifications   
  subscription             List of subscriptions
admin@ncs(config-device-dev0)# notifications subscription ncsub-dev0 
Possible completions:
  disconnect           Disconnect this subscription if connected
  local-user           The local user is used when setting up a device
                       connection.
  reconnect            Attempt to reconnect this subscription
  reconnect-interval   Interval for re-establishing the subscription
  replay               Replay (missed) notifications from the device
  store-in-cdb         Store notifications in CDB
  stream               The notification stream name
  subtree              Subtree filter for the notifications
  utilize-replay       Use replay when connecting to the device
  xpath                XPath filter for the notifications
  <cr>                 
admin@ncs(config-device-dev0)# notifications subscription ncsub-dev0 stream NETCONF xpath netconf-config-change local-user admin
admin@ncs(config-subscription-ncsub-dev0)# commit
Commit complete.
```

## Setting up Kicker to handle the netconf-config-change notification

```
admin@ncs# show devices device dev0 notifications subscription     
                     FAILURE  ERROR  
NAME        STATUS   REASON   INFO   
-------------------------------------
ncsub-dev0  running  -        -      
admin@ncs# config
Entering configuration mode terminal
admin@ncs(config)# devices authgroups group default default-map remote-name admin remote-password admin
admin@ncs(config-group-default)# commit
Commit complete.
admin@ncs(config-group-default)# top
admin@ncs(config)# unhide debug
admin@ncs(config)# kickers notification-kicker check-sync-dev0-kicker 
Value for 'selector-expr' (<string>): "$SUBSCRIPTION_NAME = 'ncsub-dev0'"
Value for 'kick-node' : /devices/device[name='dev0']/ncc:nc-config-change
Value for 'action-name' (<string, min: 1 chars>): handle-nc-config-notification
admin@ncs(config-notification-kicker-check-sync-dev0-kicker)# commit
Commit complete.
```

### Make an out-of-band config change using netconf-console and observe the actions taken by the Kicker service in logs/ncs-python-vm-nc-config-change.log

```
$ netconf-console --port=12022 --get-config -x "interfaces | acl" 
$ netconf-console --port=12022 --edit-config=xmls/acl.xml --db=candidate 
$ netconf-console --port=12022 --edit-config=xmls/oc-if.xml --db=candidate
$ netconf-console --port=12022 --commit
$ netconf-console --port=12022 --get-config -x "interfaces | acl" 
```

### Make a config change through ncs_cli and observe what happens in logs/ncs-python-vm-nc-config-change.log

```
admin@ncs(config)# devices device dev0 config
admin@ncs(config-config)# oc-if:interfaces interface GigabitEthernet0/0/0/0 hold-time config up 100
admin@ncs(config-interface-GigabitEthernet0/0/0/0)# commit
```

### Contact

Contact Wai Tai <waitai@cisco.com> with any suggestions or comments. If you find any bugs, please fix them and send me a pull request.
